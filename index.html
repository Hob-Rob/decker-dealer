<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deck Dealer ‚Äî Party Edition</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#9fb0ff; --text:#e9ecff;
      --accent:#7c5cff; --accent2:#23c483; --danger:#ff4d6d; --warn:#ffb703; --line:#24315e;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 10%, #1a2450 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      padding:18px 18px; border-bottom:1px solid var(--line);
      background: linear-gradient(90deg, rgba(124,92,255,.18), rgba(35,196,131,.12));
    }
    h1{margin:0 0 6px 0; font-size:20px; letter-spacing:.2px}
    .sub{color:rgba(233,236,255,.75); font-size:13px; line-height:1.35}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    .grid{display:grid; grid-template-columns: 380px 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .panel{
      background: rgba(18,26,51,.94);
      border: 1px solid rgba(36,49,94,.9);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 10px 14px;
      border-bottom: 1px solid rgba(36,49,94,.8);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel .hd h2{margin:0; font-size:14px; letter-spacing:.3px; color:rgba(233,236,255,.9)}
    .panel .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .btn{
      border:1px solid rgba(124,92,255,.55);
      background: rgba(124,92,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      transition:.15s transform, .15s background, .15s border;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(124,92,255,.22); border-color: rgba(124,92,255,.85)}
    .btn.green{border-color: rgba(35,196,131,.6); background: rgba(35,196,131,.12)}
    .btn.green:hover{background: rgba(35,196,131,.18); border-color: rgba(35,196,131,.9)}
    .btn.danger{border-color: rgba(255,77,109,.55); background: rgba(255,77,109,.12)}
    .btn.danger:hover{background: rgba(255,77,109,.18); border-color: rgba(255,77,109,.9)}
    .btn.warn{border-color: rgba(255,183,3,.6); background: rgba(255,183,3,.12)}
    .btn.warn:hover{background: rgba(255,183,3,.18); border-color: rgba(255,183,3,.9)}
    .btn.active{
      border-color: rgba(35,196,131,.9);
      background: rgba(35,196,131,.16);
    }
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    label{font-size:13px; color:rgba(233,236,255,.85)}
    input[type="text"]{
      background: rgba(11,16,32,.7);
      border:1px solid rgba(36,49,94,.95);
      color:var(--text);
      border-radius: 10px;
      padding:10px 10px;
      outline:none;
      flex:1;
      min-width: 160px;
    }
    .hint{font-size:12px; color:rgba(233,236,255,.65); margin-top:6px}
    .deck, .player{
      border:1px solid rgba(36,49,94,.9);
      border-radius:14px;
      padding:10px;
      background: rgba(11,16,32,.55);
    }
    .deckTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .deckName{display:flex; align-items:center; gap:10px}
    .check{display:flex; align-items:center; gap:8px}
    .pill{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(36,49,94,.95);
      color:rgba(233,236,255,.8);
      background: rgba(18,26,51,.45);
      white-space:nowrap;
    }
    .bigCard{
      min-height: 320px;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      padding:22px;
      text-align:center;
      position:relative;
    }
    .q{
      font-size: 22px;
      line-height: 1.35;
      letter-spacing:.2px;
      margin:0;
      max-width: 760px;
      white-space:pre-line;
    }
    .meta{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
      font-size:12px; color:rgba(233,236,255,.7);
    }
    .tag{
      border:1px solid rgba(36,49,94,.9);
      background: rgba(11,16,32,.55);
      padding:6px 10px;
      border-radius: 999px;
    }
    .tag.penalty{
      border-color: rgba(255,77,109,.55);
      background: rgba(255,77,109,.10);
      color: rgba(233,236,255,.92);
    }
    .tag.reward{
      border-color: rgba(35,196,131,.6);
      background: rgba(35,196,131,.10);
      color: rgba(233,236,255,.92);
    }
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(18,26,51,.95);
      border:1px solid rgba(36,49,94,.95);
      padding:10px 12px; border-radius: 12px;
      font-size:13px; color:rgba(233,236,255,.92);
      display:none;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      max-width: min(860px, calc(100vw - 24px));
      text-align:center;
      z-index: 50;
    }
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 280px; overflow:auto; padding-right:6px;
    }
    .item{
      border:1px solid rgba(36,49,94,.9);
      background: rgba(11,16,32,.55);
      border-radius: 14px;
      padding:10px;
    }
    .item .top{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .item p{margin:8px 0 0 0; color:rgba(233,236,255,.9); font-size:13px; line-height:1.35}
    .tiny{font-size:11px; color:rgba(233,236,255,.62)}
    .sep{border:none;border-top:1px solid rgba(36,49,94,.85); margin:12px 0}
    .scoreGrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
    @media (max-width: 980px){ .scoreGrid{grid-template-columns: 1fr;} }

    /* Party mode: bigger, thumb-friendly */
    body.party header{position:sticky; top:0; z-index:10; backdrop-filter: blur(6px)}
    body.party .grid{grid-template-columns: 1fr;}
    body.party .q{font-size:30px}
    body.party .btn{padding:14px 16px; font-size:16px; border-radius: 16px}
    body.party .panel{border-radius: 22px}
    body.party .bigCard{min-height: 360px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Deck Dealer ‚Äî Party Edition</h1>
    <div class="sub">
      Add players ‚Üí üé≤ Start Game ‚Üí Deal questions ‚Üí Answered / Refused.<br/>
      Includes modifiers, NSFW lock, random player turns, and a scoreboard.
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: setup -->
    <section class="panel">
      <div class="hd">
        <h2>Setup</h2>
        <span class="pill" id="statusPill">Ready</span>
      </div>
      <div class="bd">
        <details open style="margin-bottom:12px;">
          <summary style="cursor:pointer; font-weight:800; color:rgba(233,236,255,.95);">
            Rules (click to collapse)
          </summary>
          <div style="margin-top:10px; font-size:13px; line-height:1.45; color:rgba(233,236,255,.86);">
            <ul style="margin:0 0 10px 18px; padding:0;">
              <li>Tap <b>üé≤ Start Game</b> to randomly choose who starts.</li>
              <li>Tap <b>Deal</b> and read the question.</li>
              <li><b>Answered</b> = you answered honestly.</li>
              <li><b>Refused</b> = you didn‚Äôt answer ‚Üí penalty applies.</li>
            </ul>
            <div class="hint">
              Modifiers:<br/>
              ‚Ä¢ <b>Make it a double</b>: refuse ‚Üí drink double<br/>
              ‚Ä¢ <b>Buy a round</b>: refuse ‚Üí everyone else drinks<br/>
              ‚Ä¢ <b>This round‚Äôs on me</b>: answer ‚Üí give a sip to someone (random)
            </div>
          </div>
        </details>

        <hr class="sep"/>

        <label><b>Players</b></label>
        <div class="hint">Add at least 2 players. The app randomly picks whose turn it is.</div>
        <div class="row" style="margin-top:8px">
          <input id="playerInput" type="text" placeholder="Type a name‚Ä¶" />
          <button class="btn" id="addPlayerBtn">Add</button>
          <button class="btn danger" id="clearPlayersBtn">Clear</button>
        </div>

        <div id="playersList" class="list" style="margin-top:10px; max-height:180px"></div>

        <hr class="sep"/>

        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <label><b>Decks</b></label>
            <div class="hint">Extra Dirty is locked unless you unlock NSFW.</div>
          </div>
          <div class="row">
            <button class="btn" id="selectAllBtn">All</button>
            <button class="btn" id="selectNoneBtn">None</button>
          </div>
        </div>

        <div id="deckList" style="margin-top:10px"></div>

        <label class="check" style="margin-top:10px">
          <input type="checkbox" id="unlockNSFW" />
          <span><b>Unlock NSFW deck</b> (Extra Dirty)</span>
        </label>

        <hr class="sep"/>

        <label class="check">
          <input type="checkbox" id="noRepeat" checked />
          <span><b>No repeats</b> until the pool runs out</span>
        </label>

        <hr class="sep"/>

        <label><b>Round modifiers</b></label>
        <div class="hint">Tap to set one rule for this round (tap again to clear).</div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="doubleBtn" title="Refuse = double drink">Make it a double</button>
          <button class="btn" id="roundBtn" title="Refuse = everyone else drinks">Buy a round</button>
          <button class="btn" id="onMeBtn" title="Answer = give someone a sip">This round‚Äôs on me</button>
        </div>

        <hr class="sep"/>

        <div class="row" style="margin-top:8px">
          <button class="btn warn" id="startBtn">üé≤ Start Game</button>
          <button class="btn green" id="dealBtn" disabled>Deal</button>
          <button class="btn" id="partyBtn">Party Mode</button>
          <button class="btn danger" id="resetBtn">Reset</button>
        </div>

        <div class="hint" id="counts" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- RIGHT: gameplay -->
    <section class="panel">
      <div class="hd">
        <h2>Dealer</h2>
        <div class="row">
          <button class="btn" id="answeredBtn" disabled>Answered</button>
          <button class="btn danger" id="refusedBtn" disabled>Refused</button>
          <button class="btn" id="copyBtn" disabled>Copy</button>
        </div>
      </div>
      <div class="bd">
        <div class="bigCard">
          <p class="q" id="qText">Add players, then press ‚Äúüé≤ Start Game‚Äù.</p>
          <div class="meta" id="qMeta"></div>
          <div class="meta" id="resultMeta"></div>
        </div>

        <hr class="sep"/>

        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <label><b>Scoreboard</b></label>
            <div class="hint">Taken = drinks you drank. Given = drinks you handed out.</div>
          </div>
        </div>

        <div id="scoreboard" class="scoreGrid" style="margin-top:10px"></div>

        <hr class="sep"/>

        <label><b>History</b> <span class="tiny" id="historyHint"></span></label>
        <div class="list" id="history" style="margin-top:10px"></div>
      </div>
    </section>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* -----------------------------
   QUESTIONS (baked into HTML)
   Expanded with more wholesome, spicy, and risqu√© prompts.
   ----------------------------- */
const DECKS = {
  "Happy Hour": [
    // Wholesome / light / fun
    "If you could instantly be great at something, what would it be?",
    "What‚Äôs your most harmless hot take?",
    "What‚Äôs the best compliment you‚Äôve ever received?",
    "What‚Äôs a small thing that makes you ridiculously happy?",
    "What‚Äôs the best decision you‚Äôve ever made?",
    "What‚Äôs something you‚Äôre proud of that you don‚Äôt talk about much?",
    "What‚Äôs your comfort movie or show?",
    "What‚Äôs your comfort food?",
    "What‚Äôs something you‚Äôre looking forward to?",
    "What‚Äôs a hobby you‚Äôve always wanted to try?",
    "What‚Äôs your ideal day off?",
    "What‚Äôs your dream trip?",
    "What‚Äôs a song that always puts you in a good mood?",
    "What‚Äôs your favorite way to spend time with friends?",
    "What‚Äôs a random skill you have?",
    "What‚Äôs the funniest thing you‚Äôve seen online recently?",
    "What‚Äôs your favorite smell?",
    "What‚Äôs a small luxury you love?",
    "What‚Äôs a tradition you actually like?",
    "What‚Äôs something you‚Äôd tell your younger self?",
    "What‚Äôs something you want to learn this year?",
    "What‚Äôs the best meal you‚Äôve ever had?",
    "What‚Äôs a book/game you wish you could experience again for the first time?",
    "What‚Äôs your favorite season and why?",
    "What‚Äôs the nicest thing someone‚Äôs done for you?",
    "What‚Äôs the nicest thing you‚Äôve done for someone?",
    "What‚Äôs your favorite place you‚Äôve ever been?",
    "What‚Äôs a weird thing you‚Äôre nostalgic about?",
    "If you could have dinner with anyone (living or dead), who and why?",
    "What‚Äôs a goal you‚Äôre working on right now?",
    "What‚Äôs your favorite ‚Äúsimple pleasure‚Äù?",
    "What‚Äôs something you appreciate more as you get older?",
    "What‚Äôs the best advice you‚Äôve ever gotten?",
    "What‚Äôs your ‚ÄúI‚Äôm in a good mood‚Äù dance move?",
    "What‚Äôs your favorite holiday and why?",
    "If you could relive one day, which day would it be?",
    "What‚Äôs a ‚Äúgreen flag‚Äù you love in people?",
    "What‚Äôs a small thing that instantly improves your day?",
    "What‚Äôs a silly thing that scares you?",
    "What‚Äôs your favorite way to celebrate good news?",
    "What‚Äôs something you‚Äôre grateful for today?",
    "What‚Äôs a smell that brings back a memory?",
    "What‚Äôs your favorite meme format?",
    "What‚Äôs your go-to karaoke song (even if you‚Äôd never do it)?",
    "What‚Äôs a TV character you relate to?",
    "What‚Äôs a food combo you swear by that others think is weird?",
    "If you had a theme song, what would it be?",
    "What‚Äôs your favorite kind of weather?",
    "What‚Äôs your favorite thing about where you live?",
    "What‚Äôs a skill you‚Äôve improved recently?",
    "What‚Äôs the best part of your routine?",
    "If you could teleport anywhere right now, where would you go?",
    "What‚Äôs a tiny hill you‚Äôre willing to die on (harmless edition)?",
    "What‚Äôs the funniest ‚Äúmisunderstanding‚Äù you‚Äôve had?",
    "What‚Äôs a hobby you think is underrated?",

    // New wholesome / fun additions
    "What‚Äôs something you love that you wish wasn‚Äôt ‚Äúcringe‚Äù?",
    "What‚Äôs the best thing about your best friend?",
    "What‚Äôs a compliment you wish people gave you more often?",
    "What‚Äôs your ‚ÄúI‚Äôm stressed‚Äù snack or drink?",
    "What‚Äôs the nicest message you‚Äôve ever received?",
    "What‚Äôs a random thing you‚Äôre oddly good at?",
    "What‚Äôs the best smell in the world (and why is it amazing)?",
    "What‚Äôs a small habit that makes your life better?",
    "What‚Äôs the most wholesome thing you‚Äôve done this month?",
    "What‚Äôs something you‚Äôre excited to do in the next 7 days?",
    "What‚Äôs your favorite way to show someone you care?",
    "What‚Äôs a skill you‚Äôd teach your future self?",
    "What‚Äôs a movie scene that always makes you emotional?",
    "What‚Äôs a song you never skip?",
    "What‚Äôs a compliment you love giving to others?",
    "What‚Äôs your perfect ‚Äúcozy night in‚Äù plan?",
    "What‚Äôs a hobby you tried once and actually enjoyed?",
    "What‚Äôs a place that instantly calms you down?",
    "What‚Äôs a food you could eat every day?",
    "If you could have any pet (realistic), what would it be?",
    "What‚Äôs your favorite ‚Äúlittle treat‚Äù?",
    "What‚Äôs the best gift you‚Äôve ever given someone?",
    "What‚Äôs a small win you‚Äôve had recently?",
    "What‚Äôs a ‚Äúgreen flag‚Äù in a friend?",
    "What‚Äôs something you‚Äôre glad you grew out of?",
    "What‚Äôs a quote that actually helps you?",
    "What‚Äôs something you‚Äôre learning to be kinder to yourself about?",
    "If today had a vibe, what would it be?",
    "What‚Äôs your go-to feel-good YouTube/TikTok genre?",
    "If you could master one recipe, what would it be?",
    "What‚Äôs a smell that reminds you of childhood?",
    "What‚Äôs your current ‚Äúhyperfixation‚Äù (even if it‚Äôs random)?",
    "What‚Äôs something you want to do more of this year?",
    "What‚Äôs a tiny thing you can do that instantly improves your mood?",
    "What‚Äôs your favorite compliment to receive from a partner?",
    "What‚Äôs your favorite compliment to receive from a friend?",
    "If you had to pick a ‚Äúsignature‚Äù drink, what is it?",
    "What‚Äôs the most comforting sound to you?",
    "What‚Äôs a hobby that looks fun but you‚Äôve never tried?",
    "What‚Äôs the best ‚Äúlazy day‚Äù activity?",
    "What‚Äôs something you‚Äôve learned the hard way‚Ä¶ but you‚Äôre grateful for now?",
    "What‚Äôs something that always makes you laugh?",
    "What‚Äôs your favorite thing to do with no phone involved?",
    "If you could time travel for one hour, where/when would you go?",
    "What‚Äôs your ‚ÄúI‚Äôm thriving‚Äù song?",
    "What‚Äôs your favorite compliment to GIVE?",
    "What‚Äôs something you‚Äôre quietly proud of?",
    "What‚Äôs a small thing someone did that meant a lot to you?",
    "If your life had a soundtrack right now, what‚Äôs on it?",
    "What‚Äôs your most comforting memory?"
  ],

  "On the Rocks": [
    // Original
    "Have you ever fallen in love?",
    "What‚Äôs the most embarrassing thing you‚Äôve ever done?",
    "What‚Äôs the biggest lie you‚Äôve ever told?",
    "What‚Äôs the most childish thing you still do?",
    "What‚Äôs your biggest insecurity?",
    "What‚Äôs the worst thing you‚Äôve ever said to someone?",
    "What‚Äôs something you‚Äôve done that you still feel guilty about?",
    "What‚Äôs your biggest fear?",
    "What‚Äôs the most impulsive thing you‚Äôve ever done?",
    "What‚Äôs the weirdest thing you‚Äôve ever done for money?",
    "What‚Äôs the worst date you‚Äôve ever been on?",
    "What‚Äôs the most illegal thing you‚Äôve ever done?",
    "What‚Äôs the biggest mistake you‚Äôve ever made?",
    "What‚Äôs the meanest thing you‚Äôve ever done?",
    "What‚Äôs the most trouble you‚Äôve ever gotten into?",
    "What‚Äôs the worst thing you‚Äôve ever said behind someone‚Äôs back?",
    "What‚Äôs the most awkward thing you‚Äôve ever said?",
    "What‚Äôs your most irrational pet peeve?",
    "What‚Äôs something you‚Äôve done that you hope no one finds out about?",
    "If you could erase one moment from your life, what would it be?",
    "What‚Äôs the most dramatic thing you‚Äôve ever done?",
    "What‚Äôs the most ridiculous thing you‚Äôve ever cried about?",
    "What‚Äôs the most toxic thing you‚Äôve ever done in a relationship?",
    "What‚Äôs something you do that would give people the ick?",
    "What‚Äôs a secret you‚Äôve kept from your parents?",
    "What‚Äôs the most embarrassing thing you‚Äôve ever said while flirting?",
    "What‚Äôs the most cringe thing you‚Äôve ever posted online?",
    "What‚Äôs something you pretend to like but don‚Äôt?",
    "What‚Äôs your most controversial opinion?",
    "Who was your first crush and why?",
    "What‚Äôs the worst gift you‚Äôve ever received?",
    "What‚Äôs the worst gift you‚Äôve ever given?",
    "If your ex(es) were here, what would they say about you?",
    "What‚Äôs the worst thing you‚Äôve ever done while drunk?",
    "What‚Äôs the most awkward run-in you‚Äôve had with someone?",
    "What‚Äôs your biggest turn-off?",
    "What‚Äôs your biggest turn-on?",
    "What‚Äôs something you‚Äôve done out of jealousy?",
    "What‚Äôs the pettiest thing you‚Äôve ever done?",
    "What‚Äôs the pettiest reason you‚Äôve ever disliked someone?",
    "What‚Äôs the worst fashion phase you‚Äôve had?",
    "What‚Äôs the worst haircut you‚Äôve ever had?",
    "What‚Äôs the last thing you searched on your phone?",
    "What‚Äôs the weirdest thing you‚Äôve ever eaten?",
    "What‚Äôs your guilty pleasure?",
    "What‚Äôs the worst movie you‚Äôve ever loved?",
    "What‚Äôs the most embarrassing song you know all the words to?",
    "What‚Äôs the strangest dream you‚Äôve had recently?",
    "What‚Äôs a rumor you‚Äôve heard about yourself?",
    "What‚Äôs a rumor you‚Äôve started (or helped spread) about someone else?",
    "What‚Äôs the last lie you told?",
    "What‚Äôs one thing you‚Äôd change about yourself if you could?",
    "What‚Äôs something you‚Äôve stolen?",
    "What‚Äôs the worst job you‚Äôve ever had (or would never do)?",
    "What‚Äôs the worst advice you‚Äôve ever given?",
    "What‚Äôs the worst advice you‚Äôve ever taken?",
    "What‚Äôs the biggest compliment you‚Äôve ever gotten?",
    "What‚Äôs the biggest insult you‚Äôve ever gotten?",
    "If you had to delete one app forever, which would it be?",
    "Who do you compare yourself to the most?",
    "What‚Äôs the most insecure you‚Äôve ever felt?",
    "If you could read one person‚Äôs mind for a day, whose would it be and why?",
    "What‚Äôs the most dramatic thing you‚Äôve done for attention?",
    "What‚Äôs something you wish you cared less about?",

    // New: spicier but not explicit
    "What‚Äôs a red flag you ignored because they were hot?",
    "What‚Äôs the pettiest reason you‚Äôve lost interest in someone?",
    "What‚Äôs the most embarrassing ‚ÄúI was down bad‚Äù moment?",
    "What‚Äôs the worst flirt you‚Äôve ever attempted?",
    "What‚Äôs your most irrational jealousy trigger?",
    "What‚Äôs a boundary you learned the hard way?",
    "What‚Äôs the most awkward compliment you‚Äôve ever given someone you liked?",
    "What‚Äôs your biggest dating ‚Äúpattern‚Äù you‚Äôre trying to break?",
    "What‚Äôs the fastest you‚Äôve ever caught feelings (and why)?",
    "What‚Äôs something you said in the heat of the moment that you regret?",
    "What‚Äôs the most unhinged thing you‚Äôve done to get someone‚Äôs attention?",
    "What‚Äôs the biggest ‚Äúsituationship‚Äù mistake you made?",
    "What‚Äôs the most chaotic thing you‚Äôve done at 2am?",
    "What‚Äôs a compliment that instantly works on you?",
    "What‚Äôs the worst advice you‚Äôve taken in dating?",
    "What‚Äôs your biggest ‚Äúpeople-pleasing‚Äù moment?",
    "What‚Äôs the most dramatic apology you‚Äôve ever made or received?",
    "What‚Äôs your most embarrassing drunk message (roughly)?",
    "What‚Äôs the biggest green flag you ignored because you wanted drama?",
    "What‚Äôs your biggest ‚ÄúI can fix them‚Äù moment?",
    "What‚Äôs the funniest reason you‚Äôve blocked someone?",
    "What‚Äôs the most suspicious thing you‚Äôve ever snooped for?",
    "What‚Äôs something you wish you could un-say?",
    "What‚Äôs the most awkward ‚Äúseen‚Äù you‚Äôve ever left or received?",
    "What‚Äôs a harmless thing that gives you the ick?",
    "What‚Äôs a ‚Äútoxic trait‚Äù you‚Äôre working on?",
    "What‚Äôs something you‚Äôve done out of spite that you secretly enjoyed?",
    "What‚Äôs your most chaotic ‚Äúnight out‚Äù story (PG-13 version)?",
    "What‚Äôs the worst outfit you‚Äôve worn thinking you ate?",
    "What‚Äôs the most embarrassing thing you‚Äôve said trying to be smooth?",
    "What‚Äôs the last thing you deleted from your phone?",
    "What‚Äôs the most ‚Äúmain character‚Äù thing you‚Äôve done in public?",
    "What‚Äôs a rumor about you that was weirdly flattering?",
    "What‚Äôs the most awkward silence you‚Äôve ever been in?",
    "What‚Äôs your worst ‚ÄúI‚Äôm fine‚Äù lie?",
    "What‚Äôs the most ridiculous thing you‚Äôve been insecure about?",
    "What‚Äôs your most controversial food opinion?",
    "What‚Äôs something you do when you like someone that you hate about yourself?",
    "What‚Äôs the biggest lie you‚Äôve told to avoid conflict?",
    "What‚Äôs your ‚Äútype‚Äù and what‚Äôs the exception you always fall for?",
    "What‚Äôs a dealbreaker you‚Äôve ignored and regretted?",
    "What‚Äôs the funniest thing you‚Äôve cried over?",
    "What‚Äôs the worst date idea you‚Äôve ever agreed to?",
    "What‚Äôs your most awkward ‚ÄúDM slide‚Äù (approx)?",
    "What‚Äôs a compliment you still think about?",
    "What‚Äôs the most awkward thing you‚Äôve liked on social media accidentally?",
    "What‚Äôs the boldest thing you‚Äôve done that actually worked?"
  ],

  "Last Call": [
    // Original
    "Who in this group would you trust most with a secret?",
    "Who in this group would you trust least with a secret?",
    "Who in this group would survive a zombie apocalypse the longest?",
    "Who in this group would die first in a zombie apocalypse?",
    "Who in this group would make the best partner?",
    "Who in this group would make the worst partner?",
    "Who in this group is most likely to ghost someone?",
    "Who in this group is most likely to get ghosted?",
    "Who in this group would be most likely to get arrested?",
    "Who in this group would be most likely to talk their way out of getting arrested?",
    "Who in this group is most likely to become famous?",
    "Who in this group is most likely to become infamous?",
    "Who in this group is the best liar?",
    "Who in this group is the worst liar?",
    "Who in this group would you want on your trivia team?",
    "Who in this group would you not want on your trivia team?",
    "Who in this group would you want to be stuck on a deserted island with?",
    "Who in this group would you not want to be stuck on a deserted island with?",
    "Who in this group would you let set you up on a blind date?",
    "Who in this group would you never let set you up on a blind date?",
    "Who in this group would you hire first?",
    "Who in this group would you fire first?",
    "Who in this group is most likely to accidentally start a fire?",
    "Who in this group is most likely to accidentally start drama?",
    "Who in this group would you call if you needed help at 3am?",
    "Who in this group would you not call if you needed help at 3am?",
    "Who in this group would you trust to plan your birthday?",
    "Who in this group would you not trust to plan your birthday?",
    "Who in this group is most likely to have a secret second life?",
    "Who in this group is most likely to be a secret villain?",
    "Who in this group is most likely to get rich?",
    "Who in this group is most likely to stay broke?",
    "Who in this group has the best taste?",
    "Who in this group has the worst taste?",
    "Who in this group is most likely to cry at a movie?",
    "Who in this group is least likely to cry at a movie?",
    "Who in this group is most likely to flirt their way into something?",
    "Who in this group is most likely to fumble a flirt?",
    "Who in this group would you want as your roommate?",
    "Who in this group would you never want as your roommate?",
    "Who in this group is most likely to cancel plans last minute?",
    "Who in this group is most likely to be early to plans?",
    "Who in this group would you trust to babysit?",
    "Who in this group would you not trust to babysit?",
    "Who in this group is most likely to have the best comeback?",
    "Who in this group is most likely to have the worst comeback?",
    "Who in this group would win in a fight?",
    "Who in this group would lose in a fight?",
    "Who in this group is most likely to forget your birthday?",
    "Who in this group is most likely to remember your birthday?",
    "Who in this group would you want to go on a road trip with?",
    "Who in this group would you not want to go on a road trip with?",
    "Who in this group is most likely to be the best cook?",
    "Who in this group is most likely to burn water?",
    "Who in this group is most likely to give great advice?",
    "Who in this group is most likely to give terrible advice?",
    "Who in this group is most likely to be a heartbreaker?",
    "Who in this group is most likely to get their heart broken?",
    "Who in this group is most likely to text their ex?",
    "Who in this group is most likely to block their ex?",

    // New: spicier group-callout prompts (still safe)
    "Who here is most likely to fall for someone after one good conversation?",
    "Who here is most likely to have a ‚Äúsecret crush‚Äù right now?",
    "Who here has the best flirting voice?",
    "Who here would be most likely to go on a date for free food?",
    "Who here is most likely to accidentally start a situationship?",
    "Who here is most likely to catch feelings first?",
    "Who here is most likely to send the risky text?",
    "Who here is most likely to ghost and then come back like nothing happened?",
    "Who here is most likely to fall for a red flag because it‚Äôs exciting?",
    "Who here would be most likely to get married on impulse in Vegas?",
    "Who here is most likely to have a spicy secret?",
    "Who here is most likely to flirt with a stranger and succeed?",
    "Who here is most likely to flirt with a stranger and fail?",
    "Who here is most likely to have the best ‚Äúdate playlist‚Äù?",
    "Who here is most likely to be the best kisser (in theory)?",
    "Who here is most likely to have the worst poker face when they like someone?",
    "Who here is most likely to get jealous but pretend they‚Äôre chill?",
    "Who here is most likely to have the most dramatic notes app apology?",
    "Who here is most likely to ‚Äúaccidentally‚Äù like an old photo while stalking?",
    "Who here is most likely to have a secret second Instagram?",
    "Who here is most likely to be the reason the group chat is active at 2am?",
    "Who here is most likely to give the worst relationship advice with confidence?",
    "Who here is most likely to be the group‚Äôs ‚Äúdating detective‚Äù?",
    "Who here is most likely to marry for personality‚Ä¶ eventually?",
    "Who here is most likely to fall for someone who‚Äôs bad for them (again)?",
    "Who here is most likely to have a fling on holiday?",
    "Who here would be most likely to steal someone‚Äôs hoodie and never return it?",
    "Who here is most likely to become a gym crush?",
    "Who here is most likely to send a voice note instead of texting?",
    "Who here is most likely to be ‚Äúemotionally unavailable‚Äù for no reason?"
  ],

  "Extra Dirty (NSFW)": [
    // Original (non-explicit, adult party vibe)
    "What‚Äôs the weirdest thing you find attractive?",
    "What‚Äôs the fastest you‚Äôve caught feelings?",
    "What‚Äôs the biggest red flag you‚Äôve ignored?",
    "What‚Äôs the most embarrassing thing that‚Äôs happened to you while hooking up?",
    "What‚Äôs the most awkward thing you‚Äôve said right after sex?",
    "What‚Äôs the most unexpected place you‚Äôve hooked up?",
    "What‚Äôs the most unexpected person you‚Äôve been attracted to?",
    "What‚Äôs the worst text you‚Äôve sent to the wrong person?",
    "What‚Äôs the most desperate thing you‚Äôve done for attention?",
    "What‚Äôs the most unhinged thing you‚Äôve done while horny?",
    "What‚Äôs a kink you‚Äôre curious about?",
    "What‚Äôs a kink that‚Äôs a hard no for you?",
    "What‚Äôs the most petty reason you‚Äôve stopped talking to someone?",
    "What‚Äôs something you‚Äôve done that would absolutely scandalize your family?",
    "What‚Äôs the most toxic thing you‚Äôve done in a situationship?",
    "What‚Äôs the most toxic thing someone‚Äôs done to you in a situationship?",
    "What‚Äôs the most chaotic date you‚Äôve ever been on?",
    "What‚Äôs your biggest ‚Äúhear me out‚Äù crush?",
    "What‚Äôs the worst hookup you‚Äôve ever had?",
    "What‚Äôs the best hookup you‚Äôve ever had?",
    "What‚Äôs the most ridiculous thing you‚Äôve done to impress someone?",
    "What‚Äôs the most embarrassing thing you‚Äôve done for a crush?",
    "What‚Äôs the weirdest compliment you‚Äôve ever gotten?",
    "What‚Äôs the weirdest compliment you‚Äôve ever given?",
    "What‚Äôs the most scandalous rumor about you that‚Äôs actually true?",
    "What‚Äôs the most scandalous rumor about you that‚Äôs not true?",
    "What‚Äôs the meanest thing you‚Äôve ever said to a partner?",
    "What‚Äôs the meanest thing a partner has said to you?",
    "What‚Äôs the biggest age gap you‚Äôd date?",
    "What‚Äôs the biggest age gap you‚Äôve dated?",
    "What‚Äôs your worst ‚ÄúI can fix them‚Äù moment?",
    "What‚Äôs the most jealous you‚Äôve ever been?",
    "What‚Äôs the most possessive thing you‚Äôve ever done?",
    "What‚Äôs something you‚Äôve done to make someone jealous?",
    "What‚Äôs the most dramatic breakup you‚Äôve seen?",
    "What‚Äôs the most dramatic breakup you‚Äôve had?",
    "What‚Äôs the most confusing ‚Äúmixed signals‚Äù you‚Äôve gotten?",
    "What‚Äôs the most confusing ‚Äúmixed signals‚Äù you‚Äôve given?",
    "What‚Äôs your most chaotic ‚Äúdating app‚Äù story?",
    "What‚Äôs your most chaotic ‚Äúnight out‚Äù story?",
    "What‚Äôs the most regrettable thing you‚Äôve done while drunk?",
    "What‚Äôs the most regrettable thing you‚Äôve done while texting?",
    "What‚Äôs the most flirty thing you‚Äôve said that you regret?",
    "What‚Äôs the most flirty thing someone‚Äôs said to you?",
    "What‚Äôs your biggest ‚Äútoxic trait‚Äù in dating?",
    "What‚Äôs your biggest ‚Äúgreen flag‚Äù in dating?",
    "What‚Äôs something you‚Äôd never admit on a first date?",
    "What‚Äôs a dealbreaker you‚Äôve ignored?",
    "What‚Äôs the biggest lie you‚Äôve told someone you were dating?",
    "What‚Äôs the biggest lie someone told you while dating?",
    "What‚Äôs the most suspicious thing you‚Äôve snooped for?",
    "What‚Äôs the most suspicious thing you‚Äôve found while snooping?",
    "What‚Äôs the most embarrassing notification you‚Äôve gotten at the worst time?",
    "What‚Äôs your go-to move when you‚Äôre trying to seduce someone?",
    "What‚Äôs your go-to ‚ÄúI‚Äôm not interested‚Äù move?",
    "What‚Äôs your most unhinged ‚ÄúI miss you‚Äù text?",
    "What‚Äôs the most chaotic thing you‚Äôve done after a breakup?",
    "What‚Äôs something you‚Äôve forgiven that you probably shouldn‚Äôt have?",
    "What‚Äôs something you wouldn‚Äôt forgive?",
    "What‚Äôs the wildest compliment you‚Äôd actually love to hear?",
    "What‚Äôs the wildest thing you‚Äôve done out of spite?",
    "What‚Äôs the most ‚Äúmain character‚Äù thing you‚Äôve done in a relationship?",
    "What‚Äôs your biggest ‚Äúick‚Äù that you know is unreasonable?",
    "What‚Äôs the biggest boundary you‚Äôve ever set too late?",

    // New: a little more risqu√© (still not explicit / no graphic detail)
    "What‚Äôs your go-to ‚Äúflirty look‚Äù move?",
    "What‚Äôs a type you *know* is bad for you but still attracts you?",
    "What‚Äôs the boldest thing you‚Äôve ever done to show interest?",
    "What‚Äôs the most ‚Äúdangerous‚Äù person you‚Äôve been tempted by?",
    "What‚Äôs your favorite kind of foreplay (keep it classy)?",
    "What‚Äôs something that instantly turns you on (not explicit)?",
    "What‚Äôs something that instantly kills the mood for you?",
    "What‚Äôs a compliment that would make you fold immediately?",
    "What‚Äôs your biggest ‚ÄòI shouldn‚Äôt text them‚Äô moment?",
    "What‚Äôs the spiciest dream you‚Äôve had (no details needed)?",
    "What‚Äôs your biggest ‚ÄòI‚Äôm not innocent‚Äô secret (keep it vague)?",
    "What‚Äôs the most seductive song to you?",
    "What‚Äôs your favorite place to be kissed (non-graphic)?",
    "What‚Äôs a harmless fantasy you‚Äôve had?",
    "What‚Äôs a boundary you‚Äôre proud you set?",
    "What‚Äôs the most confident you‚Äôve ever felt on a date?",
    "What‚Äôs your ‚Äòthis person is trouble‚Äô tell?",
    "What‚Äôs the most flirty thing you‚Äôve done without speaking?",
    "What‚Äôs the most flirty thing you‚Äôve said that actually worked?",
    "What‚Äôs your biggest ‚Äúoops‚Äù with a risky text?",
    "What‚Äôs a kink you *don‚Äôt* have but people assume you do?",
    "What‚Äôs a ‚Äòsecret soft spot‚Äô you have in dating?",
    "What‚Äôs your most chaotic ‚Äòhear me out‚Äô crush?",
    "What‚Äôs something you find attractive that you‚Äôd never put on a dating profile?",
    "If you had to pick: slow burn or instant chemistry?",
    "What‚Äôs a ‚Äúforbidden‚Äù crush you‚Äôve had?",
    "What‚Äôs your biggest ‚ÄòI can change them‚Äô delusion?",
    "What‚Äôs the most intense eye contact moment you‚Äôve had?",
    "What‚Äôs your favorite kind of teasing (non-explicit)?",
    "What‚Äôs a risky place you‚Äôve made out (keep it PG-13)?",
    "What‚Äôs the funniest thing that‚Äôs interrupted a romantic moment?",
    "What‚Äôs your biggest ‚Äòbad idea but fun‚Äô story?",
    "What‚Äôs the most scandalous compliment you‚Äôve received?",
    "What‚Äôs the most scandalous compliment you‚Äôve given?",
    "What‚Äôs a ‚Äúdate night‚Äù idea that always works on you?",
    "What‚Äôs your biggest ‚Äòthey‚Äôre hot but‚Ä¶‚Äô moment?",
    "What‚Äôs a dirty joke you wish you could tell right now?",
    "What‚Äôs your ‚ÄòI‚Äôm flirting‚Äô body language?",
    "What‚Äôs the most attractive personality trait to you?",
    "What‚Äôs your most chaotic ‚ÄúI‚Äôm bored‚Äù text?",
    "What‚Äôs the boldest outfit you‚Äôve worn on a date?",
    "What‚Äôs a pet name you secretly like?",
    "What‚Äôs a pet name that gives you the ick?",
    "What‚Äôs your biggest guilty pleasure in attraction?",
    "What‚Äôs the biggest ‚ÄúI‚Äôd fold‚Äù celebrity crush?",
    "What‚Äôs a harmless thing you‚Äôre oddly possessive about in relationships?",
    "What‚Äôs the most chaotic thing you‚Äôve done for validation?",
    "What‚Äôs your most dramatic ‚ÄòI‚Äôm done‚Äô moment?",
    "What‚Äôs the most unhinged compliment you‚Äôve ever wanted to give someone?"
  ]
};

/* -----------------------------
   App state
   ----------------------------- */
const $ = (s)=>document.querySelector(s);
const toastEl = $("#toast");
const statusPill = $("#statusPill");

const playerInput = $("#playerInput");
const addPlayerBtn = $("#addPlayerBtn");
const clearPlayersBtn = $("#clearPlayersBtn");
const playersList = $("#playersList");

const deckListEl = $("#deckList");
const unlockNSFWEl = $("#unlockNSFW");
const noRepeatEl = $("#noRepeat");

const doubleBtn = $("#doubleBtn");
const roundBtn  = $("#roundBtn");
const onMeBtn   = $("#onMeBtn");

const startBtn = $("#startBtn");
const dealBtn = $("#dealBtn");
const partyBtn = $("#partyBtn");
const resetBtn = $("#resetBtn");

const answeredBtn = $("#answeredBtn");
const refusedBtn  = $("#refusedBtn");
const copyBtn = $("#copyBtn");

const qText = $("#qText");
const qMeta = $("#qMeta");
const resultMeta = $("#resultMeta");

const scoreboardEl = $("#scoreboard");
const historyEl = $("#history");
const historyHint = $("#historyHint");
const countsEl = $("#counts");

let players = [];                 // ["Alex", "Sam"]
let scores = {};                  // {Alex:{taken:0,given:0}, ...}
let currentPlayer = null;         // string
let lastQuestion = null;          // {deck, text}
let currentModifier = null;       // "double" | "round" | "onme" | null

let used = new Set();             // no-repeat keys
let pool = [];                    // draw pool: [{deck,text},...]
let history = [];                 // last 25: [{deck,text,by,modifier,outcome}]

const MODIFIERS = {
  double: { label:"Make it a double", desc:"Refuse ‚Üí drink double" },
  round:  { label:"Buy a round", desc:"Refuse ‚Üí everyone else drinks" },
  onme:   { label:"This round‚Äôs on me", desc:"Answer ‚Üí give someone a sip" }
};

const deckState = Object.keys(DECKS).map(name => ({
  name,
  enabled: name !== "Extra Dirty (NSFW)" // locked by default
}));

/* -----------------------------
   Helpers
   ----------------------------- */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
let toastT=null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(toastT);
  toastT = setTimeout(()=> toastEl.style.display="none", 1600);
}
function setStatus(text){
  statusPill.textContent = text;
}
function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function randInt(n){ return Math.floor(Math.random()*n); }
function chooseRandomPlayer(exceptName=null){
  if(players.length === 0) return null;
  if(players.length === 1) return players[0];
  // try a few times to avoid selecting the same person when needed
  for(let i=0;i<10;i++){
    const p = players[randInt(players.length)];
    if(!exceptName || p !== exceptName) return p;
  }
  // fallback
  return players[randInt(players.length)];
}
function keyFor(q){ return q.deck + "::" + q.text; }

/* -----------------------------
   Rendering
   ----------------------------- */
function renderPlayers(){
  playersList.innerHTML = "";
  if(players.length === 0){
    playersList.innerHTML = `<div class="hint">No players yet.</div>`;
    return;
  }

  for(const p of players){
    const div = document.createElement("div");
    div.className = "player";
    div.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <b>${escapeHtml(p)}</b>
          ${currentPlayer === p ? `<span class="pill" style="margin-left:8px;border-color:rgba(35,196,131,.7)">Current</span>` : ``}
        </div>
        <button class="btn danger" data-remove="${encodeURIComponent(p)}" title="Remove player">Remove</button>
      </div>
      <div class="hint">Taken: <b>${scores[p]?.taken ?? 0}</b> ‚Ä¢ Given: <b>${scores[p]?.given ?? 0}</b></div>
    `;
    playersList.appendChild(div);
  }

  playersList.querySelectorAll("button[data-remove]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const name = decodeURIComponent(btn.getAttribute("data-remove"));
      removePlayer(name);
    });
  });
}

function renderDecks(){
  deckListEl.innerHTML = "";
  for(const d of deckState){
    const isNSFW = d.name === "Extra Dirty (NSFW)";
    const locked = isNSFW && !unlockNSFWEl.checked;

    const wrap = document.createElement("div");
    wrap.className = "deck";
    wrap.innerHTML = `
      <div class="deckTop">
        <div class="deckName">
          <label class="check">
            <input type="checkbox" data-deck="${escapeHtml(d.name)}" ${d.enabled ? "checked":""} ${locked ? "disabled":""} />
            <span><b>${escapeHtml(d.name)}</b></span>
          </label>
          <span class="pill">${(DECKS[d.name]||[]).length} q</span>
          ${locked ? `<span class="pill" style="border-color: rgba(255,183,3,.65)">Locked</span>` : ``}
        </div>
      </div>
    `;
    deckListEl.appendChild(wrap);
  }

  deckListEl.querySelectorAll("input[data-deck]").forEach(cb=>{
    cb.addEventListener("change", (e)=>{
      const name = e.target.getAttribute("data-deck");
      const d = deckState.find(x=>x.name===name);
      d.enabled = e.target.checked;
      rebuildPool(false);
    });
  });
}

function renderScoreboard(){
  scoreboardEl.innerHTML = "";
  if(players.length === 0){
    scoreboardEl.innerHTML = `<div class="hint">Add players to see the scoreboard.</div>`;
    return;
  }

  for(const p of players){
    const card = document.createElement("div");
    card.className = "deck";
    const s = scores[p] || {taken:0,given:0};
    card.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:center">
        <b>${escapeHtml(p)} ${currentPlayer===p ? "‚Ä¢ üéØ" : ""}</b>
        <span class="pill">Taken: ${s.taken} ‚Ä¢ Given: ${s.given}</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" data-plus-taken="${encodeURIComponent(p)}">+1 Taken</button>
        <button class="btn" data-plus-given="${encodeURIComponent(p)}">+1 Given</button>
        <button class="btn danger" data-minus-taken="${encodeURIComponent(p)}">-1 Taken</button>
      </div>
    `;
    scoreboardEl.appendChild(card);
  }

  scoreboardEl.querySelectorAll("button[data-plus-taken]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const p = decodeURIComponent(b.getAttribute("data-plus-taken"));
      scores[p].taken += 1;
      renderPlayers(); renderScoreboard();
    });
  });
  scoreboardEl.querySelectorAll("button[data-plus-given]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const p = decodeURIComponent(b.getAttribute("data-plus-given"));
      scores[p].given += 1;
      renderPlayers(); renderScoreboard();
    });
  });
  scoreboardEl.querySelectorAll("button[data-minus-taken]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const p = decodeURIComponent(b.getAttribute("data-minus-taken"));
      scores[p].taken = Math.max(0, scores[p].taken - 1);
      renderPlayers(); renderScoreboard();
    });
  });
}

function renderHistory(){
  historyEl.innerHTML = "";
  if(history.length === 0){
    historyEl.innerHTML = `<div class="hint">No pulls yet.</div>`;
    historyHint.textContent = "";
    return;
  }
  historyHint.textContent = `‚Ä¢ showing ${Math.min(25, history.length)} of ${history.length}`;

  for(const h of history.slice(0,25)){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="top">
        <span class="pill">${escapeHtml(h.deck)}</span>
        <span class="tiny">${escapeHtml(h.by)} ‚Ä¢ ${h.outcome}</span>
      </div>
      <p>${escapeHtml(h.text)}</p>
      <div class="tiny" style="margin-top:8px">
        Modifier: ${h.modifier ? escapeHtml(h.modifier) : "None"}
      </div>
    `;
    historyEl.appendChild(div);
  }
}

function updateCounts(){
  const enabledDecks = deckState
    .filter(d => d.enabled && !(d.name==="Extra Dirty (NSFW)" && !unlockNSFWEl.checked))
    .map(d => d.name);

  const selectedQ = enabledDecks.reduce((sum,name)=>sum + (DECKS[name]?.length||0), 0);
  countsEl.textContent = selectedQ
    ? `Selected questions: ${selectedQ} ‚Ä¢ Used: ${used.size} ‚Ä¢ Players: ${players.length}`
    : `Select at least 1 deck.`;
}

/* -----------------------------
   Pool + meta
   ----------------------------- */
function enabledDeckNames(){
  return deckState
    .filter(d => d.enabled)
    .map(d => d.name)
    .filter(name => !(name==="Extra Dirty (NSFW)" && !unlockNSFWEl.checked));
}

function rebuildPool(clearUsed){
  const enabled = enabledDeckNames();
  const next = [];
  for(const name of enabled){
    for(const q of (DECKS[name]||[])){
      next.push({ deck:name, text:q });
    }
  }
  pool = shuffleArray(next);
  if(clearUsed) used = new Set();
  updateCounts();
  setStatus(pool.length ? "Ready" : "No decks selected");
}

function setModifier(key){
  if(currentModifier === key){
    currentModifier = null;
  }else{
    currentModifier = key;
  }
  doubleBtn.classList.toggle("active", currentModifier==="double");
  roundBtn.classList.toggle("active",  currentModifier==="round");
  onMeBtn.classList.toggle("active",   currentModifier==="onme");
  renderQuestionMeta();
}

function renderQuestionMeta(){
  const pieces = [];

  if(currentPlayer){
    pieces.push(`<span class="tag">Current: <b>${escapeHtml(currentPlayer)}</b></span>`);
  }
  if(lastQuestion){
    pieces.push(`<span class="tag">Deck: <b>${escapeHtml(lastQuestion.deck)}</b></span>`);
  }
  if(currentModifier){
    pieces.push(`<span class="tag">Rule: <b>${escapeHtml(MODIFIERS[currentModifier].label)}</b></span>`);
  }
  qMeta.innerHTML = pieces.join("");
}

function clearOutcome(){
  resultMeta.innerHTML = "";
}

function setOutcomeTag(kind, text){
  const cls = kind === "refused" ? "penalty" : "reward";
  resultMeta.innerHTML = `<span class="tag ${cls}"><b>${escapeHtml(text)}</b></span>`;
}

/* -----------------------------
   Gameplay
   ----------------------------- */
function canPlay(){
  if(players.length < 2){
    toast("Add at least 2 players.");
    return false;
  }
  if(enabledDeckNames().length === 0){
    toast("Select at least 1 deck.");
    return false;
  }
  return true;
}

function startGame(){
  if(!canPlay()) return;

  currentPlayer = chooseRandomPlayer();
  lastQuestion = null;
  clearOutcome();

  qText.textContent = `üé≤ ${currentPlayer} starts the game!`;
  renderQuestionMeta();

  dealBtn.disabled = false;
  answeredBtn.disabled = true;
  refusedBtn.disabled = true;
  copyBtn.disabled = true;

  renderPlayers(); renderScoreboard();
  toast(`${currentPlayer} starts!`);
}

function drawQuestion(){
  if(pool.length === 0){
    rebuildPool(false);
    if(pool.length === 0) return null;
  }

  const noRepeat = noRepeatEl.checked;

  for(let tries=0; tries<pool.length; tries++){
    const q = pool.pop();
    const k = keyFor(q);
    if(!noRepeat || !used.has(k)){
      if(noRepeat) used.add(k);
      return q;
    }
  }

  // everything used
  used = new Set();
  rebuildPool(false);
  toast("Reshuffled üîÑ");
  return pool.pop() || null;
}

function deal(){
  if(!canPlay()) return;
  if(!currentPlayer){
    toast("Press ‚Äúüé≤ Start Game‚Äù first.");
    return;
  }

  const q = drawQuestion();
  if(!q){
    toast("No questions available.");
    return;
  }

  lastQuestion = q;
  clearOutcome();

  qText.textContent = `${currentPlayer}'s turn:\n\n${q.text}`;
  renderQuestionMeta();

  answeredBtn.disabled = false;
  refusedBtn.disabled = false;
  copyBtn.disabled = false;

  updateCounts();
}

function nextTurn(){
  currentPlayer = chooseRandomPlayer();
  renderPlayers();
  renderScoreboard();
  renderQuestionMeta();
  setTimeout(()=>{
    if(!lastQuestion) return;
    qText.textContent = `Next up: ${currentPlayer}\n\nTap Deal for the next question.`;
    renderQuestionMeta();
  }, 900);
}

function answered(){
  if(!currentPlayer || !lastQuestion){
    toast("Deal a question first.");
    return;
  }

  clearOutcome();

  if(currentModifier === "onme"){
    const target = chooseRandomPlayer(currentPlayer);
    scores[currentPlayer].given += 1;
    scores[target].taken += 1;

    setOutcomeTag("answered", `Answered ‚Üí ${currentPlayer} gives a sip to ${target} üçª`);
    toast(`${currentPlayer} ‚Üí ${target} üçª`);
  }else{
    setOutcomeTag("answered", `Answered ‚úÖ No penalty`);
    toast("Answered ‚úÖ");
  }

  history.unshift({
    deck: lastQuestion.deck,
    text: lastQuestion.text,
    by: currentPlayer,
    modifier: currentModifier ? MODIFIERS[currentModifier].label : null,
    outcome: "Answered"
  });
  history = history.slice(0, 200);

  renderPlayers(); renderScoreboard(); renderHistory();
  nextTurn();
}

function refused(){
  if(!currentPlayer || !lastQuestion){
    toast("Deal a question first.");
    return;
  }

  clearOutcome();

  if(currentModifier === "round"){
    for(const p of players){
      if(p !== currentPlayer) scores[p].taken += 1;
    }
    setOutcomeTag("refused", `Refused ‚Üí Everyone else drinks üçª`);
    toast("Everyone else drinks üçª");
  } else {
    const amount = currentModifier === "double" ? 2 : 1;
    scores[currentPlayer].taken += amount;
    setOutcomeTag("refused", `Refused ‚Üí ${currentPlayer} drinks ${amount} üçª`);
    toast(`${currentPlayer} drinks ${amount} üçª`);
  }

  history.unshift({
    deck: lastQuestion.deck,
    text: lastQuestion.text,
    by: currentPlayer,
    modifier: currentModifier ? MODIFIERS[currentModifier].label : null,
    outcome: "Refused"
  });
  history = history.slice(0, 200);

  renderPlayers(); renderScoreboard(); renderHistory();
  nextTurn();
}

/* -----------------------------
   Player management
   ----------------------------- */
function addPlayer(){
  const name = (playerInput.value || "").trim();
  if(!name) return toast("Type a name first.");
  if(players.includes(name)) return toast("That name is already added.");

  players.push(name);
  scores[name] = scores[name] || { taken:0, given:0 };
  playerInput.value = "";

  if(!currentPlayer && players.length >= 2){
    setStatus("Ready to start");
  }

  renderPlayers();
  renderScoreboard();
  updateCounts();
}

function removePlayer(name){
  players = players.filter(p=>p!==name);
  delete scores[name];

  if(currentPlayer === name){
    currentPlayer = players.length ? chooseRandomPlayer() : null;
  }

  if(players.length < 2){
    dealBtn.disabled = true;
    answeredBtn.disabled = true;
    refusedBtn.disabled = true;
    copyBtn.disabled = true;
    currentPlayer = null;
    lastQuestion = null;
    qText.textContent = "Add players, then press ‚Äúüé≤ Start Game‚Äù.";
    qMeta.innerHTML = "";
    clearOutcome();
  }

  renderPlayers();
  renderScoreboard();
  renderQuestionMeta();
  updateCounts();
}

function clearPlayers(){
  players = [];
  scores = {};
  currentPlayer = null;
  lastQuestion = null;

  dealBtn.disabled = true;
  answeredBtn.disabled = true;
  refusedBtn.disabled = true;
  copyBtn.disabled = true;

  qText.textContent = "Add players, then press ‚Äúüé≤ Start Game‚Äù.";
  qMeta.innerHTML = "";
  clearOutcome();

  renderPlayers();
  renderScoreboard();
  updateCounts();
  toast("Players cleared.");
}

/* -----------------------------
   Events
   ----------------------------- */
addPlayerBtn.addEventListener("click", addPlayer);
playerInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") addPlayer();
});
clearPlayersBtn.addEventListener("click", clearPlayers);

unlockNSFWEl.addEventListener("change", ()=>{
  const nsfw = deckState.find(d=>d.name==="Extra Dirty (NSFW)");
  if(!unlockNSFWEl.checked){
    nsfw.enabled = false;
  }
  renderDecks();
  rebuildPool(false);
});

$("#selectAllBtn").addEventListener("click", ()=>{
  for(const d of deckState){
    if(d.name==="Extra Dirty (NSFW)" && !unlockNSFWEl.checked){
      d.enabled = false;
    }else{
      d.enabled = true;
    }
  }
  renderDecks();
  rebuildPool(false);
  toast("Selected decks updated.");
});
$("#selectNoneBtn").addEventListener("click", ()=>{
  for(const d of deckState){
    d.enabled = false;
  }
  renderDecks();
  rebuildPool(false);
  toast("Selected none.");
});

noRepeatEl.addEventListener("change", ()=>{
  toast(noRepeatEl.checked ? "No repeats ON" : "No repeats OFF");
});

doubleBtn.addEventListener("click", ()=> setModifier("double"));
roundBtn.addEventListener("click",  ()=> setModifier("round"));
onMeBtn.addEventListener("click",   ()=> setModifier("onme"));

startBtn.addEventListener("click", startGame);
dealBtn.addEventListener("click", deal);
answeredBtn.addEventListener("click", answered);
refusedBtn.addEventListener("click", refused);

copyBtn.addEventListener("click", async ()=>{
  if(!lastQuestion) return;
  try{
    await navigator.clipboard.writeText(lastQuestion.text);
    toast("Copied ‚úÖ");
  }catch{
    toast("Copy failed (browser blocked).");
  }
});

partyBtn.addEventListener("click", ()=>{
  document.body.classList.toggle("party");
  toast(document.body.classList.contains("party") ? "Party Mode ON üéâ" : "Party Mode OFF");
});

resetBtn.addEventListener("click", ()=>{
  currentModifier = null;
  doubleBtn.classList.remove("active");
  roundBtn.classList.remove("active");
  onMeBtn.classList.remove("active");

  used = new Set();
  pool = [];
  history = [];
  lastQuestion = null;
  currentPlayer = null;

  qText.textContent = "Add players, then press ‚Äúüé≤ Start Game‚Äù.";
  qMeta.innerHTML = "";
  clearOutcome();

  dealBtn.disabled = true;
  answeredBtn.disabled = true;
  refusedBtn.disabled = true;
  copyBtn.disabled = true;

  for(const p of players){
    scores[p].taken = 0;
    scores[p].given = 0;
  }

  renderPlayers();
  renderScoreboard();
  renderHistory();
  rebuildPool(true);

  setStatus("Ready");
  toast("Reset ‚úÖ (scores cleared, decks reshuffled)");
});

/* -----------------------------
   Init
   ----------------------------- */
function init(){
  renderDecks();
  rebuildPool(true);
  renderPlayers();
  renderScoreboard();
  renderHistory();
  updateCounts();
  setStatus("Ready");
}
init();
</script>
</body>
</html>


